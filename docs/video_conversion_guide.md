# 视频批量转码使用指南

## 问题说明

所有现有视频使用 `mp4v/FMP4` 编码，浏览器不支持播放。需要转码为 `H.264` 编码。

## 快速开始

```bash
# 1. 运行批量转码脚本
python batch_convert_videos.py

# 2. 按照提示确认操作
# 3. 等待转码完成
# 4. 刷新浏览器，视频应该可以播放了
```

## 脚本功能

### ✅ 核心功能

- **自动检测编码**：扫描所有视频，自动识别需要转码的文件
- **智能跳过**：已经是H.264的视频会自动跳过
- **安全备份**：转码前自动备份原文件到 `./backups/` 目录
- **保持命名**：转码后的文件使用原文件名（覆盖）
- **进度显示**：实时显示转码进度
- **统计报告**：完成后显示详细统计信息

### 🛡️ 安全机制

1. **双重确认**
   - 启动前确认
   - 显示转码列表后二次确认

2. **自动备份**
   - 原文件自动备份到 `./backups/` 目录
   - 备份文件名格式: `原文件名_20251120_112345_backup.mp4`
   - 失败时自动从备份恢复

3. **输出验证**
   - 转码后验证文件是否有效
   - 验证编码格式是否正确
   - 验证至少能读取一帧

## 使用流程

### 步骤1: 运行脚本

```bash
python batch_convert_videos.py
```

### 步骤2: 查看预检查结果

脚本会显示：
```
找到 92 个视频文件

正在检查编码格式...

需要转码: 85 个
已是H.264: 7 个

需要转码的文件:
  - batch_20251120_103327.mp4 (FMP4)
  - batch_20251120_103551.mp4 (FMP4)
  ... 还有 83 个文件
```

### 步骤3: 确认并开始

```
开始转码 85 个文件？(yes/no): yes
```

### 步骤4: 等待转码完成

脚本会显示每个文件的转码进度：
```
================================================================================
📹 处理: batch_20251120_103327.mp4
================================================================================
原始编码: FMP4
分辨率: 1920x1200
帧率: 1.00 FPS
总帧数: 144
尝试编码器: avc1... ✓ 成功

⏳ 开始转码...
  进度: 144/144 (100.0%)
✓ 转码完成，耗时: 1.26秒
✓ 原文件已备份: batch_20251120_103327_20251120_112345_backup.mp4
✓ 文件已替换: batch_20251120_103327.mp4
  原始大小: 18.57 MB (FMP4)
  新文件大小: 39.28 MB (H.264)
  大小变化: +111.6%
```

### 步骤5: 查看统计报告

```
================================================================================
📊 转码统计
================================================================================
总计: 92 个文件
  ✓ 成功转码: 85 个
  ⊘ 跳过（已是H.264）: 7 个
  ✗ 失败: 0 个
================================================================================

💾 备份位置: D:\project\workday\backups
   (转码成功后可删除备份文件以节省空间)

⏱️  总耗时: 127.45秒
```

## 转码后验证

### 1. 在浏览器测试

```bash
# 访问前端页面
http://127.0.0.1:8000

# 点击任意timeline card查看视频
# 视频应该可以正常播放
```

### 2. 检查编码格式

```bash
# 检查单个文件
python check_video_codec.py recordings/batch_20251120_103327.mp4

# 应该显示：
# ✅ H.264 (avc1) - 浏览器完全支持
```

### 3. 使用调试页面

```
访问: http://127.0.0.1:8000/debug_video.html
```

## 清理备份文件

**验证视频播放正常后**，可以删除备份文件以节省空间：

```bash
# Windows
rmdir /s /q backups

# Linux/Mac
rm -rf backups
```

## 文件大小说明

**为什么转码后文件变大了？**

- **原因**：H.264和mp4v使用不同的压缩算法
- **增幅**：通常增加100-150%
- **优势**：虽然文件大，但浏览器兼容性好

**如果需要减小文件大小：**

使用ffmpeg可以获得更好的压缩效果：

```bash
# 安装ffmpeg（如果没有）
# Windows: https://ffmpeg.org/download.html

# 转码单个文件（更好的压缩）
ffmpeg -i input.mp4 -c:v libx264 -preset medium -crf 23 output.mp4

# CRF值说明：
# - 18-23: 高质量（推荐）
# - 23-28: 中等质量，更小文件
# - 28+: 低质量
```

## 故障排除

### 问题1: 转码失败

**症状**：
```
✗ 错误: 无法创建H.264编码器
```

**解决方案**：
1. 确保OpenCV正确安装：`pip install opencv-python`
2. 尝试使用ffmpeg替代（见上文）
3. 检查系统是否支持H.264编码

### 问题2: 备份恢复

如果需要手动恢复备份：

```bash
# 1. 找到备份文件
cd backups
dir  # Windows
ls   # Linux/Mac

# 2. 复制回原位置
copy batch_XXX_backup.mp4 ..\recordings\batch_XXX.mp4  # Windows
cp batch_XXX_backup.mp4 ../recordings/batch_XXX.mp4   # Linux/Mac
```

### 问题3: 数据库路径未更新

如果文件名没变，数据库中的`video_path`不需要更新。如果遇到问题，重启API服务即可：

```bash
# 停止API（Ctrl+C）
# 重新启动
python api.py
```

## 相关工具

脚本集合：

1. **batch_convert_videos.py** - 批量转码主脚本（本文档）
2. **check_video_codec.py** - 检查视频编码格式
3. **convert_video.py** - 单文件转码工具
4. **debug_video.html** - 浏览器调试页面

## 预期结果

转码完成后：

✅ 所有视频使用H.264编码
✅ 浏览器可以正常播放
✅ 支持视频拖动和暂停
✅ 支持HTTP Range请求
✅ 前端页面视频正常显示

## 时间估算

- **每个视频转码时间**：约1-2秒
- **92个视频总耗时**：约2-3分钟
- **备份空间需求**：约2倍原视频大小（临时）

开始转码吧！
